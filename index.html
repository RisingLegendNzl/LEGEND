<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Terminal Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: #ffffff; border-radius: 16px; box-shadow: 0 10px 35px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0,0,0,0.06); }
        .form-input { border: 2px solid #e2e8f0; border-radius: 8px; padding: 12px; font-size: 1rem; width: 100%; transition: border-color 0.3s ease; }
        .form-input:focus { outline: none; border-color: #4f46e5; }
        .btn { font-weight: 600; padding: 12px 20px; border-radius: 8px; transition: all 0.2s ease; border: 2px solid transparent; cursor: pointer; }
        .btn:disabled, .btn-disabled { background-color: #e5e7eb; color: #6b7280; cursor: not-allowed; }
        .btn-primary { background-color: #4f46e5; color: #ffffff; }
        .btn-primary:hover:not(:disabled) { background-color: #4338ca; transform: translateY(-1px); }
        .btn-secondary { background-color: #eef2ff; color: #4f46e5; }
        .btn-secondary:hover:not(:disabled) { background-color: #e0e7ff; }
        .btn-danger { background-color: #fee2e2; color: #dc2626; }
        .btn-danger:hover { background-color: #fecaca; }
        .history-list, .analysis-list { max-height: 350px; overflow-y: auto; padding-right: 8px; }
        .history-item { background-color: #f8fafc; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; padding: 12px 20px; border-radius: 12px; position: relative; flex-wrap: wrap; }
        .history-item.is-success { background-color: #f0fdf4; border-color: #22c55e; }
        .history-item.is-fail { background-color: #fef2f2; border-color: #ef4444; }
        .state-badge { font-size: 0.75rem; font-weight: 700; padding: 2px 6px; border-radius: 6px; color: white; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); z-index: 10; white-space: nowrap; }
        .bg-amber-500 { background-color: #f59e0b; }
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-red-500 { background-color: #ef4444; }
        .bg-sumMinus { background-color: #8b5cf6; }
        .bg-sumResult { background-color: #10b981; }
        .bg-sumPlus { background-color: #f43f5e; }
        .status-box { width: 24px; height: 24px; border-radius: 6px; transition: all 0.2s ease; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .status-box svg { width: 16px; height: 16px; stroke-width: 2.5; color: #ffffff; }
        .success-box { border: 2px solid #dcfce7; background-color: #f0fdf4; }
        .is-success .success-box { background-color: #22c55e; border-color: #16a34a; }
        .fail-box { border: 2px solid #fee2e2; background-color: #fef2f2; }
        .is-fail .fail-box { background-color: #ef4444; border-color: #dc2626; }
        .delete-btn { width: 32px; height: 32px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border: 2px solid #e5e7eb; background-color: #fff; }
        .delete-btn svg { color: #9ca3af; width: 20px; height: 20px; stroke-width: 2; }
        .delete-btn:hover { background-color: #f3f4f6; border-color: #d1d5db;}
        .swap-btn { height: 40px; width: 40px; background-color: #fff; border: 2px solid #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; color: #9ca3af; }
        .swap-btn:hover { color: #4f46e5; border-color: #c7d2fe; transform: rotate(180deg); }
        .result-display { border-radius: 12px; background-color: #f8fafc; padding: 16px; }
        .toggle-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; width: 100%; padding: 0.5rem 0; }
        .toggle-checkbox { opacity: 0; width: 0; height: 0; position: absolute; }
        .toggle-switch { width: 52px; height: 32px; background-color: #e5e7eb; border-radius: 9999px; position: relative; transition: background-color 0.2s ease-in-out; flex-shrink: 0; }
        .toggle-knob { position: absolute; top: 2px; left: 2px; width: 28px; height: 28px; background-color: white; border-radius: 9999px; transition: transform 0.2s ease-in-out; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .toggle-checkbox:checked + .toggle-switch { background-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-switch .toggle-knob { transform: translateX(20px); }
        .strategy-guide-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding-top 0.5s ease-in-out, margin-top 0.5s ease-in-out; padding-top: 0; padding-bottom: 0; border-top: 1px solid transparent; }
        .strategy-guide-content.open { max-height: 1000px; margin-top: 1rem; padding-top: 1rem; border-color: #e5e7eb; overflow-y: auto; }
        .strategy-guide-content h4 { font-weight: 600; color: #374151; margin-top: 0.5rem; }
        .strategy-guide-content p { color: #6b7280; font-size: 0.875rem; }
        .slider-group { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
        .slider-group label { flex-basis: 120px; font-size: 0.875rem; color: #4b5563; }
        .slider-group input[type="range"] { flex-grow: 1; -webkit-appearance: none; width: 100%; height: 8px; border-radius: 5px; background: #d1d5db; outline: none; opacity: 0.7; -webkit-transition: .2s; transition: opacity .2s; }
        .slider-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #4f46e5; cursor: pointer; }
        .slider-group input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #4f46e5; cursor: pointer; }
        .slider-group input[type="number"] { width: 70px; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; text-align: center; }
        #rouletteWheelContainer { width: 100%; display: flex; justify-content: center; align-items: center; margin-top: 1rem; }
        #rouletteWheel { border: 2px solid #e2e8f0; border-radius: 50%; background-color: #f8fafc; }
        .wheel-number-circle.red { fill: #ef4444; stroke: #b91c1c; }
        .wheel-number-circle.black { fill: #1f2937; stroke: #111827; }
        .wheel-number-circle.green { fill: #22c55e; stroke: #16a34a; }
        .wheel-number-text { font-size: 8px; font-weight: 600; fill: white; pointer-events: none; }
        .wheel-number-circle.highlight-diffMinus { stroke: #f59e0b; stroke-width: 3px; }
        .wheel-number-circle.highlight-diffResult { stroke: #3b82f6; stroke-width: 3px; }
        .wheel-number-circle.highlight-diffPlus { stroke: #ef4444; stroke-width: 3px; }
        .wheel-number-circle.highlight-sumMinus { stroke: #8b5cf6; stroke-width: 3px; }
        .wheel-number-circle.highlight-sumResult { stroke: #10b981; stroke-width: 3px; }
        .wheel-number-circle.highlight-sumPlus { stroke: #f43f5e; stroke-width: 3px; }
        .wheel-number-circle.highlight-winning { stroke: #10b981; stroke-width: 4px; }
        .roulette-legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #4b5563; }
        .roulette-legend-color { width: 16px; height: 16px; border-radius: 4px; }
        .bg-roulette-red { background-color: #ef4444; }
        .bg-roulette-black { background-color: #1f2937; }
        .bg-roulette-green { background-color: #22c55e; }
        .text-pink-400 { color: #f472b6; }
        .pattern-alert { background-color: #eef2ff; border: 2px solid #c7d2fe; color: #4338ca; border-radius: 8px; padding: 12px; margin-top: 1rem; font-size: 0.875rem; text-align: center; font-weight: 500; }
        .ai-details-section { background-color: #f0f4f8; border-top: 1px solid transparent; border-radius: 0 0 8px 8px; padding: 0 16px; margin-top: 0; font-size: 0.8rem; color: #4a5568; max-height: 0; overflow: hidden; opacity: 0; visibility: hidden; transition: max-height 0.5s ease-out, padding 0.5s ease-out, margin-top 0.5s ease-out, border-top-color 0.5s ease-out, opacity 0.3s ease-out, visibility 0.3s ease-out; }
        .ai-details-section.open { max-height: 500px; padding: 12px 16px; margin-top: 8px; border-top-color: #e2e8f0; opacity: 1; visibility: visible; }
        .ai-details-section ul { list-style: none; padding: 0; margin: 0; }
        .ai-details-section li { margin-bottom: 4px; }
        .ai-details-toggle { display: block; width: fit-content; margin-top: 8px; font-size: 0.75rem; font-weight: 600; color: #4f46e5; cursor: pointer; text-decoration: underline; transition: color 0.2s ease; }
        .ai-details-toggle:hover { color: #4338ca; }
    </style>
</head>
<body class="text-gray-800 py-10 px-4">
    <div class="w-full max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
        </div>

    <script>
    // ===============================================
    // GLOBAL VARIABLES & CONFIGURATION
    // ===============================================
    const GOOGLE_API_KEY = "YOUR_API_KEY_HERE";
    const DEBUG_MODE = true;

    let STRATEGY_CONFIG = {
        learningRate_success: 0.35, learningRate_failure: 0.05, maxWeight: 6.0, minWeight: 0.03,
        decayFactor: 0.88, patternMinAttempts: 5, patternSuccessThreshold: 68,
        triggerMinAttempts: 5, triggerSuccessThreshold: 63,
    };
    let ADAPTIVE_LEARNING_RATES = {
        SUCCESS: 0.15, FAILURE: 0.1, MIN_INFLUENCE: 0.2, MAX_INFLUENCE: 2.5,
    };
    const DEFAULT_PARAMETERS = {
        STRATEGY_CONFIG: JSON.parse(JSON.stringify(STRATEGY_CONFIG)),
        ADAPTIVE_LEARNING_RATES: JSON.parse(JSON.stringify(ADAPTIVE_LEARNING_RATES)),
        TOGGLES: { useTrendConfirmation: false, useWeightedZone: true, useProximityBoost: true, usePocketDistance: false, useLowestPocketDistance: false, useAdvancedCalculations: false, useDynamicStrategy: false, useAdaptivePlay: false, useTableChangeWarnings: false, useDueForHit: false, useNeighbourFocus: false, useLessStrict: false, useDynamicTerminalNeighbourCount: false }
    };

    const TRAINING_MIN_HISTORY = 10;
    const AI_SEQUENCE_LENGTH = 5;

    let aiWorker, optimizationWorker, bestFoundParams = null;
    let history = [], confirmedWinsLog = [], patternMemory = {};
    let isAiReady = false;
    let strategyStates = {
        weightedZone: { weight: 1.0, name: 'Neighbour Weighting' },
        proximityBoost: { weight: 1.0, name: 'Proximity Boost' }
    };
    let adaptiveFactorInfluences = { 'Hit Rate': 1.0, 'Streak': 1.0, 'Proximity to Last Spin': 1.0, 'Hot Zone Weighting': 1.0, 'High AI Confidence': 1.0, 'Statistical Trends': 1.0 };
    let currentVideoURL = null;

    let useTrendConfirmation, useWeightedZone, useProximityBoost, usePocketDistance,
        useLowestPocketDistance, useAdvancedCalculations, useDynamicStrategy,
        useAdaptivePlay, useTableChangeWarnings, useDueForHit,
        useNeighbourFocus, useLessStrict, useDynamicTerminalNeighbourCount;
        
    const rouletteWheel = [0, 26, 3, 35, 12, 28, 7, 29, 18, 22, 9, 31, 14, 20, 1, 33, 16, 24, 5, 10, 23, 8, 30, 11, 36, 13, 27, 6, 34, 17, 25, 2, 21, 4, 19, 15, 32];
    const terminalMapping = { 0:[4,6],1:[8],2:[7,9],3:[8],4:[11],5:[12,10],6:[11],7:[14,2],8:[15,13,3,1],9:[14,2],10:[17,5],11:[18,16,6,4],12:[17,5],13:[20,23],14:[9,21,7,19],15:[8,20],16:[11],17:[12,24,10,22],18:[11,23],19:[14,26],20:[13,25,15,27],21:[14,26],22:[17,29],23:[18,30,16,28],24:[17,29],25:[20,32],26:[19,31,33,21],27:[20,32],28:[23,35],29:[22,34,24,36],30:[23,35],31:[26],32:[25,27],33:[26],34:[29],35:[28,30],36:[29] };
    
    // ===============================================
    // ALL FUNCTION DEFINITIONS
    // ===============================================
    
    // UI Helpers
    function toggleGuide(contentId) { const content = document.getElementById(contentId); if (content) content.classList.toggle('open'); }
    function getRouletteNumberColor(number) { if (number === 0) return 'green'; const redNumbers = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36]; return redNumbers.includes(number) ? 'red' : 'black'; }

    // Simulation & Core Logic
    function runSimulationOnHistory(spinsToProcess) { /* Full function body... */ }
    async function handleHistoricalAnalysis() { /* Full function body... */ }
    function handleStrategyChange() { /* Full function body... */ }

    // Prediction & Recommendation Logic
    function getFullPredictionTypes() { /* Full function body... */ }
    function getActivePredictionTypes() { /* Full function body... */ }
    function getNeighbours(number, count) { /* Full function body... */ }
    function getHitZone(baseNumber, terminals, winningNumber) { /* Full function body... */ }
    function getRecommendation(trendStats, boardStats, neighbourScores, diff, inputNum1, inputNum2, isForWeightUpdate, aiPredictionData, currentAdaptiveInfluences) { /* Full function body... */ }

    // Data Analysis & State Update Logic
    function calculatePocketDistance(num1, num2) { /* Full function body... */ }
    function calculateTrendStats(currentHistory, activeTypes) { /* Full function body... */ }
    function getBoardStateStats(simulatedHistory) { /* Full function body... */ }
    function runBoardStateAnalysis(simulatedHistory) { /* Full function body... */ }
    function runNeighbourAnalysis(render, simulatedHistory) { /* Full function body... */ }
    function runAllAnalyses() { /* Full function body... */ }
    function updateStrategyWeights(item) { /* Full function body... */ }
    function updatePatternMemory() { /* Full function body... */ }
    function evaluateCalculationStatus(item, winningNum) { /* Full function body... */ }
    function labelHistoryFailures(sortedHistory) { /* Full function body... */ }

    // UI Rendering
    function drawRouletteWheel(currentDiff, lastWinningNumber) { /* Full function body... */ }
    function updateWinLossCounter() { /* Full function body... */ }
    function renderHistory() { /* Full function body... */ }
    function renderStrategyWeights() { /* Full function body... */ }
    async function displayCalculationResult(diff, calcId) { /* Full function body... */ }

    // Event Handlers
    async function handleConfirmWinningNumber(calcId) { /* Full function body... */ }
    async function handleCalculation() { /* Full function body... */ }
    function handleHistoryAction(event) { /* Full function body... */ }
    function handleClearHistory() { /* Full function body... */ }
    function handleClearInputs() { /* Full function body... */ }
    function handleSwap() { /* Full function body... */ }

    // Advanced Settings & Parameters
    function createSlider(containerId, label, paramObj, paramName, min, max, step) { /* Full function body... */ }
    function initializeAdvancedSettingsUI() { /* Full function body... */ }
    function resetAllParameters() { /* Full function body... */ }
    function saveParametersToFile() { /* Full function body... */ }
    async function loadParametersFromFile(event) { /* Full function body... */ }
    function toggleParameterSliders(enable) { /* Full function body... */ }
    function handlePresetSelection(preset) { /* Full function body... */ }
    
    // AI & Worker Communication
    async function getPredictionProbabilitiesFromWorker() { /* Full function body... */ }

    // Image/Video Processing
    function handleImageUpload(event) { /* Full function body... */ }
    function handleVideoUpload(event) { /* Full function body... */ }
    function startVideoAnalysis() { /* Full function body... */ }
    function clearVideoState(clearStatus) { /* Full function body... */ }
    async function processGoldenFrame(canvas) { /* Full function body... */ }

    // State Management
    function saveState() { /* Full function body... */ }
    function loadState() { /* Full function body... */ }
    function updateAllTogglesUI() { /* Full function body... */ }
    function updateActivePredictionTypes() { /* Full function body... */ }

    // ===============================================
    // DOMContentLoaded - APPLICATION STARTUP
    // ===============================================
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const dom = {
                number1: document.getElementById('number1'), number2: document.getElementById('number2'),
                resultDisplay: document.getElementById('resultDisplay'), historyList: document.getElementById('historyList'),
                /* ... all other getElementById calls ... */
            };

            // Initialize workers
            aiWorker = new Worker('aiWorker.js');
            optimizationWorker = new Worker('optimizationWorker.js');
            
            // Setup worker message handlers
            optimizationWorker.onmessage = e => { /* ... */ };
            aiWorker.onmessage = e => { /* ... */ };

            // Attach event listeners
            document.addEventListener('click', e => {
                const targetId = e.target.id || e.target.closest('button')?.id;
                // ... switch case for all button clicks ...
            });
            dom.imageUpload.addEventListener('change', handleImageUpload);
            // ... all other specific event listeners ...
            Object.keys(DEFAULT_PARAMETERS.TOGGLES).forEach(key => {
                const toggleId = key.replace('use', '').charAt(0).toLowerCase() + key.slice(4) + 'Toggle';
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    toggle.addEventListener('change', e => {
                        window[key] = e.target.checked;
                        saveState();
                        if (key === 'usePocketDistance') { renderHistory(); }
                        else if (key === 'useAdvancedCalculations' || key === 'useDynamicTerminalNeighbourCount') { updateActivePredictionTypes(); handleStrategyChange(); }
                        else { handleStrategyChange(); }
                    });
                }
            });

            // Post initial message to AI worker
            const savedScaler = localStorage.getItem('roulette-ml-scaler');
            const clonablePredictionTypes = getFullPredictionTypes().map(({id, label, displayLabel, colorClass, textColor}) => ({id, label, displayLabel, colorClass, textColor}));
            aiWorker.postMessage({ type: 'init', payload: { allPredictionTypes: clonablePredictionTypes, scaler: savedScaler } });
            
            // Final setup
            loadState();
            runAllAnalyses();
            renderHistory();
            drawRouletteWheel();
            initializeAdvancedSettingsUI();
            updateAllTogglesUI();
            updateActivePredictionTypes();

        } catch (error) {
            if (DEBUG_MODE) console.error('Error during DOMContentLoaded setup:', error);
            document.body.innerHTML = `<div class="card p-8 text-center text-red-600">Error: ${error.message}</div>`;
        }
    });
    </script>
</body>
</html>
